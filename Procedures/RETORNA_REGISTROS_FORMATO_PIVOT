CREATE PROCEDURE [dbo].[RETORNA_REGISTROS_FORMATO_PIVOT]
@TABELA VARCHAR(MAX),
@CAMPO VARCHAR(MAX),
@FORMATO_PIVOT AS VARCHAR(MAX) OUTPUT

AS

BEGIN
DECLARE  @QUERY AS NVARCHAR(MAX)
		,@DYNAMICPARAMDEC AS NVARCHAR(MAX)

SET @CAMPO = 'CONVERT(VARCHAR(MAX), ' + @CAMPO + ')'
SET @QUERY = 'SELECT @CAMPOS = (SELECT DISTINCT ''], ['' + ' + @CAMPO + CHAR(13)
SET @QUERY = @QUERY + 'FROM ' + @TABELA + ' ORDER BY 1 ' + CHAR(13)
SET @QUERY = @QUERY + 'FOR XML PATH('''')'
SET @QUERY = @QUERY + ')'
SET @DYNAMICPARAMDEC = '@CAMPOS VARCHAR(MAX) OUTPUT'

EXECUTE SP_EXECUTESQL
    @QUERY,
    @DYNAMICPARAMDEC,
    @FORMATO_PIVOT OUTPUT

SET @FORMATO_PIVOT = STUFF(@FORMATO_PIVOT, 1,3, '') + ']';

END
